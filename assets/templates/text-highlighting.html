<div id="app" style="text-align: center">
  <h1>Effect AI - Sensitive Data Tagger</h1>

  <hr />

  <div class="mx-auto" style="max-width: 80%">

  <p class="mb-5">Highlight and tag the important/secret data</p>
  <div @mouseup="handleTextSelection" class="box">
    <p class="is-size-4 has-text-weight-semibold">{{sentence}}</p>
  </div>

  <div class="mb-5">
    <label class="label">Select Tag</label>
    <div class="buttons is-centered">
      <button class="button is-normal" @click="this.selectedTag='[NAME]'">[NAME]</button>
      <button class="button is-normal" @click="this.selectedTag='[DATE_1]'">[DATE_1]</button>
      <button class="button is-normal" @click="this.selectedTag='[TIME_1]'">[TIME_1]</button>
      <button class="button is-normal" @click="this.selectedTag='[LOCATION]'">[LOCATION]</button>
      <button class="button is-normal" @click="this.selectedTag='[EMAIL]'">[EMAIL]</button>
      <button class="button is-normal" @click="this.selectedTag='[PHONE]'">[PHONE]</button>
      <button class="button is-normal" @click="this.selectedTag='[ID]'">[ID]</button>
      <button class="button is-normal" @click="this.selectedTag='[OTHER]'">[OTHER]</button>
    </div>
  </div>

  <div class="has-text-centered">
    <div class="is-flex is-justify-content-center is-align-items-center mb-2" style="gap: 0.5rem;">
      <p>Current Selection:</p>
      <input class="input" type="text" placeholder="Type selection here" v-model="selection" style="max-width: 300px;" />
    </div>
  </div>
    
    <p>Tag Chosen: <b class="has-text-info">{{ selectedTag || 'None' }}</b></p>
    <button class="button is-success mt-3" @click="addSelection">Add Tag</button>
  </div>

  <div class="container is-max-desktop box mt-5">
    <label class="label">Current Tag Pairs:</label>

    <!-- <div class="mb-2" v-for="([selection, tagSelected], index) in selectionList" :key="index">
      {{ selection }} -> {{ tagSelected }} 

      <button class="button is-small is-danger"
      @click="removeSelection(index)">Remove</button>
    </div>       -->
    <div v-for="([sel, tag], index) in selectionList" :key="index"
      class="is-flex is-justify-content-space-between is-align-items-center mb-2 p-2 mx-auto"
      style="background-color:#f1f5f9; border-radius:8px; max-width: 50%;">
      <div>
        <strong>{{ sel }}</strong>
        <span class="tag is-info is-light ml-2">{{ tag }}</span>
      </div>
      <button class="delete is-small" @click="removeSelection(index)"></button>
    </div>

  </div>

  <p style="color: red;"
  :class="{'is-hidden mb-3': !notComplete}">
    Task incomplete - Please complete all sections of the task
  </p>

  <button
    @click.prevent="uploadAndSubmit"
    class="button is-success is-large"
    :class="{'is-loading': btnLoading}"
  >
    Submit
  </button>
</div>

<!-- ðŸ“š Load in resources: [Bulma, Effect Network Styling]  -->
<link rel="stylesheet" href="https://unpkg.com/bulma@0.9.4/css/bulma.min.css" />
<link href="https://app.effect.network/force-defaults.css" rel="stylesheet" />

<script type="module">
  import { createApp } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

  createApp({
    data() {
      return {
        title: "Effect AI Sentence Redaction",
        btnLoading: false,
        sentence: "The meeting is set for 1984-12-30 at 20:22:34 in Karenfurt.",
        loading: true,
        notComplete: false,
        selection: "",
        selectionList: [],
        selectedTag: "",
        instructions: `
          <div class="">
            <li>Highlight any sensitive or personal information in the sentence</li>
            <li>Tag each highlighted section with the correct label</li>
            <li>Once a selection and tag are selected, click "Add" to add the pair to the list</li>
            <li>Only tag information that clearly identifies someone or something private</li>
            <li>Double-check that each tag is accurate before submitting</li>
            <br>
            <h2 class="text-lg">Use these labels:</h2>
              <ul>
                <li><strong>[NAME]</strong> - e.g. John Smith, Sarah</li>
                <li><strong>[DATE]</strong> - e.g. July 18, 2025, last Monday</li>
                <li><strong>[TIME]</strong> - e.g. 3:45 PM, noon</li>
                <li><strong>[LOCATION]</strong> - e.g. Toronto, 123 Main St</li>
                <li><strong>[EMAIL]</strong> - e.g. john@example.com</li>
                <li><strong>[PHONE]</strong> - e.g. (555) 123-4567</li>
                <li><strong>[ID]</strong> - e.g. passport number, SSN</li>
                <li><strong>[OTHER]</strong> - any other identifying or sensitive info</li>
              </ul>
            </li>
          </div>
        `
      };
    },
    computed: {},
    created() {},
    mounted() {
      window.top.postMessage(
        {
          type: 'task-instructions',
          instructions: this.instructions
        },
        "*"
      );
    },
    methods: {
      handleTextSelection() {
        const selection = window.getSelection()
        const text = selection?.toString().trim()

        this.selection = text
      },
      addSelection(){
        if (this.selection == "" || this.selectedTag == ""){
          alert("You are missing a selection!")
        }
        else{
          this.selectionList.push([this.selection,this.selectedTag])
          this.selection = ""
        }
        
      },
      removeSelection(index){
        this.selectionList.splice(index, 1)
      },
      async uploadAndSubmit() {
        this.btnLoading = true;
        parent.postMessage(
          {
            task: "submit",
            values: {
              taskTitle: this.title,
              sentence: this.sentence,
              answer: this.selectionList
            },
          },
          "*"
        );
        this.btnLoading = false;
      },
    },
  }).mount("#app");
</script>
