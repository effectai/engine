<div id="app" style="text-align: center">
  <h1>Effect AI - Question Recording Verification</h1>

  <hr />

  <div class="mx-auto" style="max-width: 80%">
    <div class="box">
      <p class="is-size-4 has-text-weight-semibold">{{ question }}</p>
    </div>

    <div class="mb-4">
      <audio :src="recordingUrl" controls controlslist="nodownload" style="width: 25%;"></audio>
    </div>

    <hr />

    <div class="mx-auto" style="text-align: center; max-width: 50%">
      <h2 class="is-size-4 has-text-weight-semibold mb-5">Recording Metadata</h2>

      <div v-for="field in metadataFields" :key="field.label" class="field mb-6">
        <label class="label">{{ field.label }}</label>
        <div class="buttons is-centered">
          <button
            v-for="option in field.options"
            :key="option.value"
            class="button"
            :class="{ 'is-primary': field.model === option.value }"
            @click="setFieldValue(field, option.value)"
          >
            {{ option.text }}
          </button>
        </div>
      </div>
    </div>

    <p style="color: red;" v-if="isIncomplete">
      Task incomplete - Please complete all sections of the task
    </p>

    <button
      @click.prevent="uploadAndSubmit"
      class="button is-success is-large"
      :class="{ 'is-loading': btnLoading }"
    >
      Submit
    </button>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/bulma@0.9.4/css/bulma.min.css" />

<script type="module">
import { createApp, reactive } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

createApp({
  data() {
    const metadata = reactive({
      voiceGender: "",
      voiceClarity: "",
      backgroundNoise: "",
      speakingPace: "",
      accent: "",
      audioQuality: ""
    });

    return {
      title: "Effect AI - Question Recording Verification",
      btnLoading: false,
      author: "${submissionByPeer}",
      question: JSON.parse("${result}").values.question,
      recordingUrl: JSON.parse("${result}").values.recording,
      isValidated: "",
      metadata,
      metadataFields: [
        {
          label: 'Does the recording clearly and correctly answer the question?',
          key: 'isValidated',
          model: "",
          options: [
            { text: 'Yes', value: 'Yes' },
            { text: 'No', value: 'No' }
          ]
        },
        {
          label: 'Perceived voice gender',
          key: 'voiceGender',
          model: "",
          options: [
            { text: 'Male', value: 'male' },
            { text: 'Female', value: 'female' },
            { text: 'Cannot determine', value: 'unknown' }
          ]
        },
        {
          label: 'Is the voice clear and intelligible?',
          key: 'voiceClarity',
          model: "",
          options: [
            { text: 'Clear', value: 'clear' },
            { text: 'Mostly clear', value: 'mostly_clear' },
            { text: 'Unclear', value: 'unclear' }
          ]
        },
        {
          label: 'Background noise level',
          key: 'backgroundNoise',
          model: "",
          options: [
            { text: 'None', value: 'none' },
            { text: 'Low', value: 'low' },
            { text: 'Moderate', value: 'moderate' },
            { text: 'High', value: 'high' }
          ]
        },
        {
          label: 'Speaking pace',
          key: 'speakingPace',
          model: "",
          options: [
            { text: 'Slow', value: 'slow' },
            { text: 'Normal', value: 'normal' },
            { text: 'Fast', value: 'fast' }
          ]
        },
        {
          label: 'Noticeable accent',
          key: 'accent',
          model: "",
          options: [
            { text: 'None', value: 'none' },
            { text: 'Mild', value: 'mild' },
            { text: 'Strong', value: 'strong' }
          ]
        },
        {
          label: 'Overall audio quality',
          key: 'audioQuality',
          model: "",
          options: [
            { text: 'Good', value: 'good' },
            { text: 'Acceptable', value: 'acceptable' },
            { text: 'Poor', value: 'poor' }
          ]
        }
      ],
      instructions: `
        <div>
            <h2>Verify a Recording Answering a Question</h2>
            <p>
              In this task, you will listen to short recordings made by other contributors.
              Your goal is to decide whether the speaker clearly and appropriately answered
              the question shown.
            </p>

            <h3>1. Instructions</h3>
            <ul>
              <li>Listen carefully to the entire recording.</li>
              <li>Check that the recording actually answers the displayed question.</li>
              <li>Make sure the response is clear, understandable, and spoken in natural English.</li>
              <li>The answer should be brief and focused, not a long explanation.</li>
              <li>If the audio is cut off, extremely noisy, or does not answer the question, mark it as <strong>No</strong>.</li>
            </ul>

            <h3>2. Mark as <strong>Yes</strong> if:</h3>
            <ul>
              <li>The recording clearly answers the question.</li>
              <li>The response is easy to understand and spoken naturally.</li>
              <li>The recording is complete and not cut off.</li>
              <li>There is no distracting background noise.</li>
              <li>The response stays reasonably short.</li>
            </ul>

            <h3>3. Mark as <strong>No</strong> if:</h3>
            <ul>
              <li>The speaker does not answer the question.</li>
              <li>The response is unrelated or extremely vague.</li>
              <li>The recording is too long or rambles without answering clearly.</li>
              <li>The audio is too quiet, distorted, or partially missing.</li>
              <li>There is heavy background noise or overlapping speech.</li>
              <li>The recording contains personal or identifying information.</li>
            </ul>

            <h3>4. Mark as <strong>Skip</strong> if:</h3>
            <ul>
              <li>You are unsure whether the response adequately answers the question.</li>
              <li>The audio fails to play or is corrupted.</li>
            </ul>

            <h3>5. Tips</h3>
            <ul>
              <li>Focus on whether the question is answered, not on perfect wording.</li>
              <li>Minor accents or speech differences are acceptable if the response is clear.</li>
              <li>Do not judge the content of the answer, only its clarity and relevance.</li>
              <li>Use headphones if possible.</li>
            </ul>
          </div>
        `
    };
  },
  computed: {
    isIncomplete() {
      return (
        this.isValidated === "" ||
        Object.values(this.metadata).some(value => value === "")
      );
    }
  },
  mounted() {
      window.top.postMessage(
        {
          type: "task-instructions",
          instructions: this.instructions,
        },
        "*"
      );
    },
  methods: {
    setFieldValue(field, value) {
      if (field.key === "isValidated") {
        this.isValidated = value;
      } else {
        this.metadata[field.key] = value;
      }
      field.model = value;
    },
    uploadAndSubmit() {
      this.btnLoading = true;
      if (this.isIncomplete) {
        this.btnLoading = false;
        return;
      }
      try {
        parent.postMessage(
          {
            task: "submit",
            values: {
              taskTitle: this.title,
              author: this.author,
              question: this.question,
              recording: this.recordingUrl,
              metadata: { ...this.metadata },
              isValidated: this.isValidated,
            },
          },
          "*"
        );
      } catch (error) {
        console.error("Failed to submit", error);
      }
      this.btnLoading = false;
    }
  }
}).mount("#app");
</script>
