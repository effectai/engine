<div id="app" style="text-align: center">
  <h1>Effect AI - Sensitive Data Tagger</h1>

  <hr />

  <div class="mx-auto" style="max-width: 80%">

  <p class="mb-5">Highlight and tag the important/secret data</p>
  <div @mouseup="handleTextSelection" class="box">
    <p class="is-size-4 has-text-weight-semibold">{{sentence}}</p>
  </div>

  <div class="mb-5">
    <label class="label">Tags</label>
    <div class="buttons is-centered">
      <button class="button is-normal" @click="this.selectedTag='[NAME]'">[NAME]</button>
      <button class="button is-normal" @click="this.selectedTag='[DATE_1]'">[DATE_1]</button>
      <button class="button is-normal" @click="this.selectedTag='[TIME_1]'">[TIME_1]</button>
    </div>
  </div>

  <div class="">
    <p>Selection: <b>{{ selection }}</b></p>
    <p>Tag: <b>{{ selectedTag }}</b></p>
    <button class="button is-success mt-3" @click="addSelection">Add</button>
  </div>

  <div class="container is-max-desktop box mt-5 ">
    <label class="label">Current Tag Pairs:</label>

    <div class="mb-2" v-for="([selection, tagSelected], index) in selectionList" :key="index">
      {{ selection }} -> {{ tagSelected }} 

      <button class="button is-small is-danger"
      @click="removeSelection(index)">Remove</button>
    </div>      

  </div>

  <p style="color: red;"
  :class="{'is-hidden mb-3': !notComplete}">
    Task incomplete - Please complete all sections of the task
  </p>

  <button
    @click.prevent="uploadAndSubmit"
    class="button is-success is-large"
    :class="{'is-loading': btnLoading}"
  >
    Submit
  </button>
</div>

<!-- ðŸ“š Load in resources: [Bulma, Effect Network Styling]  -->
<link rel="stylesheet" href="https://unpkg.com/bulma@0.9.4/css/bulma.min.css" />
<link href="https://app.effect.network/force-defaults.css" rel="stylesheet" />

<script src="https://cdn.jsdelivr.net/npm/ipfs-http-client/dist/index.min.js"></script>
<script type="module">
  import { createApp } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

  createApp({
    data() {
      return {
        title: "Effect AI Sentence Redaction",
        btnLoading: false,
        // sentence: "${sentence}",
        sentence: "Hi, my name is Sarah Thompson and I was born on March 14, 1990. You can reach me at sarah.t90@gmail.com or call me at +1 416-555-2390. I live in Toronto, Canada, and work at MedTech Group as a clinical researcher.",
        loading: true,
        notComplete: false,
        selection: "",
        selectionList: [],
        selectedTag: "",
        instructions: `
          <div class="">
            <h3 class="title is-4">Misreadings</h3>
            <p>Reading all the words on the page correctly does matter. When listening, check very carefully that what has been recorded is exactly what has been written; reject if they have added, contracted or missed words.</p>
            <br>
            <h4 class="title is-5">Very common mistakes include:</h4>
            <li>Missing 'A' or 'The' at the beginning of the recording.</li>
            <li>Missing an 's' at the end of a word.</li>
            <li>Reading contractions that aren't actually there, such as "We're" instead of "We are", or vice versa.</li>
            <li>Missing the end of the last word by cutting off the recording too quickly.</li>
            <li>Taking several attempts to read a word.</li>
          </div>
        `
      };
    },
    computed: {},
    created() {},
    mounted() {
      window.top.postMessage(
        {
          type: 'task-instructions',
          instructions: this.instructions
        },
        "*"
      );
    },
    methods: {
      handleTextSelection() {
        const selection = window.getSelection()
        const text = selection?.toString().trim()

        this.selection = text
      },
      addSelection(){
        this.selectionList.push([this.selection,this.selectedTag])
      },
      removeSelection(index){
        this.selectionList.splice(index, 1)
      },
      async uploadAndSubmit() {
        this.btnLoading = true;
          try {
            parent.postMessage(
              {
                task: "submit",
                values: {
                  taskTitle: this.title,
                  sentence: this.sentence,
                  answer: JSON.parse(JSON.stringify(this.selectionList))
                },
              },
              "*"
            );
            
          } catch (error) {
            console.error("Failed to upload to IPFS", error);
          }
        this.btnLoading = false;
      },
    },
  }).mount("#app");
</script>
